---
import { getCollection } from 'astro:content';
import BlogCard from './BlogCard.astro';

interface Props {
  currentSlug: string;
  category: string;
  tags: string[];
  limit?: number;
}

const { currentSlug, category, tags, limit = 3 } = Astro.props;

// Get all blog posts
const allPosts = await getCollection('blog');

// Score posts based on relevance
const scoredPosts = allPosts
  .filter(post => post.slug !== currentSlug)
  .map(post => {
    let score = 0;

    // Same category = 3 points
    if (post.data.category === category) {
      score += 3;
    }

    // Each matching tag = 1 point
    const matchingTags = post.data.tags.filter(tag => tags.includes(tag));
    score += matchingTags.length;

    return { post, score };
  })
  .filter(item => item.score > 0)
  .sort((a, b) => {
    // Sort by score first, then by date
    if (b.score !== a.score) {
      return b.score - a.score;
    }
    return b.post.data.pubDate.getTime() - a.post.data.pubDate.getTime();
  })
  .slice(0, limit);

const relatedPosts = scoredPosts.map(item => item.post);
---

{relatedPosts.length > 0 && (
  <section class="related-posts">
    <h2 class="related-posts-title">Related Articles</h2>
    <div class="related-posts-grid">
      {relatedPosts.map((post) => (
        <BlogCard
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          heroImage={post.data.heroImage}
          category={post.data.category}
          slug={post.slug}
        />
      ))}
    </div>
  </section>
)}

<style>
  .related-posts {
    margin-top: 64px;
    padding-top: 48px;
    border-top: 1px solid var(--border-color);
  }

  .related-posts-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 32px;
    color: var(--text-dark);
  }

  .related-posts-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  @media (max-width: 1024px) {
    .related-posts-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .related-posts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
